# vim: set ft=toml :


# https://github.com/jdx/mise/pull/8308
min_version = '2026.2.20'


[settings]
locked = true
lockfile = true


[tasks.all]
alias = 'default'
run = [
  { task = 'dbt-deps' },
  { task = 'dbt-run' },
  { task = 'dbt-test' },
  { task = 'mf' },
]

[tasks.dbt-deps]
run = 'pixi run -- dbt deps'

[tasks.dbt-run]
depends = ['jafgen']
run = 'pixi run -- dbt run'

[tasks.dbt-test]
run = 'pixi run -- dbt test'

[tasks.hooks-install]
hide = true
run = [{ task = 'hooks-uninstall' }, 'hk install --mise']

[tasks.hooks-uninstall]
env = { GIT_HOOKS_DIR = '.git/hooks' }
hide = true
run = [
  'mkdir -p -- "${GIT_HOOKS_DIR}"',
  'find -- "${GIT_HOOKS_DIR}" -mindepth 1 -delete',
]

[tasks.install]
run = ['mise install', { task = 'hooks-install' }, 'pixi install --all']

[tasks.jafgen]
outputs = ['jaffle-data/*.csv']
run = 'pixi run -- jafgen'

[tasks.lint]
run = 'hk fix --all'

[tasks.lock]
run = [
  'truncate -s 0 -- mise.lock',
  'mise lock --platform linux-arm64,linux-x64,macos-arm64',
]

[tasks.mf]
run = [{ task = 'mf-health-checks' }, { task = 'mf-validate-configs' }]

[tasks.mf-health-checks]
run = 'pixi run -- mf health-checks'

[tasks.mf-validate-configs]
run = 'pixi run -- mf validate-configs --show-all --verbose-issues'

[tasks.upgrade]
depends = ['install']
env = { PKL = 'hk.pkl' }
run = [
  """\
hk_ver() { mise tool --json -- hk | jq -r -- '.active_versions[]' | sort -r -V | head -n 1; } && \
hk_str() { printf '%s' "package://github.com/jdx/hk/releases/download/v${1}/hk@${1}"; } && \
OLD="$(hk_str "$(hk_ver)")" && \
env -- MISE_LOCKED=0 mise upgrade && \
mise run lock && \
NEW="$(hk_str "$(hk_ver)")" && \
sd -F -- "${OLD}" "${NEW}" "${PKL}";""",
  'pixi update',
]


[tools]
hk = 'latest'
jq = 'latest'
pixi = 'latest'
pkl = 'latest'
sd = 'latest'
